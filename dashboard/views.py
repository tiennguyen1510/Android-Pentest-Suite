from django.http import HttpResponse
from django.shortcuts import render
from django.conf import settings
from django.core.files.storage import FileSystemStorage
from .forms import IpForm
from utils import common
from utils import cmd
import subprocess

def index(request):    
    return render(request, 'dashboard.html')

def connect_upload(request):
    # xoa resource cu
    common.delete_old_resource()
    
    # xu ly file apk duoc upload
    if request.method == 'POST' and request.FILES['apk_file']:
        apk_file = request.FILES['apk_file']
        fs = FileSystemStorage()
        apk_name = fs.save(apk_file.name, apk_file)
        apk_name = apk_name.replace(".apk", "")
    # ghi ten apk vao app_list.txt
    app_list = open('outdir/app_list.txt','w')
    app_list.writelines(apk_name)
    app_list.close()

    return render(request, 'dashboard.html', {
        'isFailed' : False,
        'isOk' : True
    })

def connect_ip(request):
    # xoa resource cu
    common.delete_old_resource()
    # ket qua ket noi
    isOk = True

    if request.method == 'POST':
        form = IpForm(request.POST)

        # ket noi voi thiet bi qua IP
        connect_result = cmd.do_cmd(["adb", "connect", form['ip'].value()])
        # kiem tra ket qua ket noi
        if "connected" in connect_result:
            # lay danh sach app cua dien thoai
            cmd.do_cmd(["sh", "scripts/get_app_list.sh"])
        else:
            isOk = False

    return render(request, 'dashboard.html', {
        'isFailed' : not isOk,
        'isOk' : isOk
    })

def connect_usb(request):
    # xoa resource cu
    common.delete_old_resource()
    # ket qua ket noi
    isOk = True

    if request.method == 'POST':

        # ket noi voi thiet bi qua IP
        connect_result = cmd.do_cmd(["adb", "connect", "usb"])
        # kiem tra ket qua ket noi
        if "connected" in connect_result:
            # lay danh sach app cua dien thoai
            cmd.do_cmd(["sh", "scripts/get_app_list.sh"])
        else:
            isOk = False

    return render(request, 'dashboard.html', {
        'isFailed' : not isOk,
        'isOk' : isOk
    })